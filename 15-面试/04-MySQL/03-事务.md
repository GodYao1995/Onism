[TOC]

### 事务

#### 什么是数据库事务？

1.  事务一个不可分割的数据库操作序列，数据库并发控制的基本单位
2.  事务执行的结果是数据库从一种一致性状态转变到另一种一致性状态
3.  要么事务中命令全部执行，要么全都不执行

#### 事务的ACID特性？

1.  原子性，事务是最小的执行单位，不允许分割，确保动作全部执行或者全部不执行
2.  一致性，事务执行前后，数据保持一致，多个事务对同一个数据的读取相同
3.  隔离性，并发访问数据库，一个用户的事务不被其他的事务所干扰，并发事务是独立的
4.  持久性，一个事务被提交后，对数据库中的数据改变是持久的

#### 事务问题？

1.  脏读：A事务更新，B事务读取，但是A由于某些原因回滚了，导致B事务读取的数据不正确
2.  不可重复读：一个事务的两次查询之中数据不一致，两次查询之间其他的事务更新了数据
3.  幻读：一个事务的两次查询记录数目不一致，两次查询之间其他事务插入了数据

#### 事务的隔离级别？

1.  读未提交，可能发生脏读、不可重复读、幻读
2.  读提交，可能发生不可重复读、幻读
3.  可重复读，对同一字段的读取是一致的，可能发生幻读
4.  可串行化，最高隔离级别符合ACID特性，所有事务依次执行

MySQL默认使用可重复读，事务隔离机制的实现基于锁机制和并发调度。其中并发调度使用的是MVVC（多版本并发控制），通过保存修改的旧版本信息来支持并发一致性读和回滚等特性

### 锁

当数据库有并发事务的时候，可能导致产生的数据不一致，这就需要锁机制来保障访问的次序

#### 隔离级别和锁的关系？

1.  读未提交，不需要加共享锁
2.  读提交，读操作加共享锁，语句执行完成释放锁
3.  可重复读，读操作加共享锁，事务执行完成以后才释放共享锁
4.  可串行化，事务执行完成才释放锁

#### 分类

1.  行级锁 InnoDB，开销大，加锁慢，锁粒度小，发生锁冲突概率低，并发度高
2.  表锁 MyISAM，开销小，锁粒度大，发生锁冲突概率高，并发度低
3.  页级锁

InnoDB实现了三种锁，行锁的实现是基于索引的

从类别上看，分为共享锁，和排他锁

#### 死锁

多个事务在同一资源上相互占用，并且请求锁定对方资源

1.  如果并发存取多个表，尽量控制访问顺序
2.  同一个事务，尽量一次锁定所需要的资源
3.  业务处理不好可以使用分布式锁或者乐观锁

#### 乐观锁、悲观锁

1.  悲观锁，假定会发生并发冲突，屏蔽一切可能导致数据不完整的操作，采用数据库锁机制
2.  乐观锁，假定不会发生并发冲突，只是在提交的时候检查是否违背数据完整性。在修改的时候把事务锁起来，通过version版本机制实现。适用于写少的情况。