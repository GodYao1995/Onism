[toc]

## Redis面试基础部分



#### 问题 0：为什么使用Redis？

目前传统基于硬盘的数据库如MySQL已经不能完全的适配高并发高流量的互联网模型

1.  大型应用的高流量接口访问,极其有可能将数据库打崩,Redis是基于内存的高性能缓存所以可以应对这种热点数据
2.  Redis提供丰富的数据类型以及高级功能, 如String, Hash, Zset, HyperLogLog, Bitmap, 分布式锁, Bloom Filter等
3.  Redis还提供高可用的哨兵主从同步与集群化水平扩展机制



#### 问题 1：Redis和MC的区别？

**MC**

1.  MC采用单进程多线程异步IO，可以有效的利用多核心，性能非常的高
2.  功能简单，基本上只有缓存功能，并且没有持久化功能和主从同步
3.  MC可对缓存的数据设置过期时间，过期后数据会被清除
4.  当容量满时，MC会对数据剔除，对过期的Key进行清理，或者按照LRU清除
5.  Key不能超过250字节、Value不能超过1M
6.  Key最大失效期30天
7.  MC内存管理Slab Allocation，是按照预先规定的大小， 将分配的内存分割成**特定长度的块**以存储相应长度的 key-value 数据记录，以完全解决内存碎片问题，缺点就是变长数据无法充分利用这些空间

**Redis**

1.  Redis同样是基于内存的缓存数据库，采用的是单线程非阻塞IO异步事件处理，避免上下文切换
2.  支持多种丰富的数据结构、多种功能，比如List的列表应用，用户消息，评论、zset排行榜
3.  支持多种持久化机制
4.  支持主从同步master-slave、集群提供水平可伸缩服务
5.  默认内存管理jemalloc，也是划分大小不一的内存块，但是一旦需要重新分配不会立马回收，所以Redis有内存碎片



#### 问题 2：Redis有哪些基本的数据结构？以及他们的适用场景？

1.  有String、Hash、List、Set、Zset

2.  还有一些高级数据结构的比如BitMap、HyperLogLog、Geo、Pub/Sub

3.  String【SDS简单动态字符串，预分配冗余内存空间方式避免多次分配内存】

    *   常规简单的字符串数据缓存
    *   计数器
    *   共享Session【Redis集中管理用户的Session】

4.  Hash, 类似Map的一种结构, 缓存结构化对象

5.  List

    *   一般用作列表型数据, 比如文章列表、评论列表, 而且非常方便于分页并且性能很高
    *   消息队列的简单实用
    *   lrange可以做分页

6.  Set

    *   无序集合去重的特性
    *   集合并集、交集、差集, 可以用来做粉丝列表、共同好友

7.  Zset

    *   有序集合, 通过key的权重【score分数】排序
    *   排行榜【多种的排序方式：时间、点击率、播放量等】比如微博的热搜榜

    

#### 问题 3：Redis有那些高级的功能

1.  BitMap, 支持按照bit位来存储信息, 可以来做布隆过滤器
2.  HyperLogLog, 提供不精确的计数功能
3.  Geospatial, 保存地理位置信息, 并可以做位置距离计算, 实现附近的人
4.  Pub/Sub发布订阅, 可以用来做消息队列
5.  PipLine, 批量执行一组指令, 减少网络请求IO次数
6.  Lua, Redis支持提交Lua脚本来执行功能, 比如秒杀场景



#### 问题 4：大量Key需要设置同一时间过期，要注意什么？

1.  大量Key同时过期可能造成Redis卡顿，并且如果同时大量的访问进入，严重的话可能造成缓存雪崩
2.  一般情况下，可以给需要过期的Key设置随机的过期时间，尽量不要让大量的Key同一时间过期



#### 问题 5：缓存的类型？

1.  本地缓存，直接内存访问
2.  分布式缓存【Redis等】
3.  多级缓存【本地缓存+分布式缓存】



#### 问题 6：数据库与缓存数据一致性问题？

1.  如果是MySQL数据源改变，那么我们在MySQL更新完毕后可以对Redis进行主动的更新
2.  可以对Redis的数据进行失效处理，去请求数据源，然后重新更新到缓存

数据还是不一致？

1.  如果是业务对耗时不明显，那么可以重试几次
2.  异步任务去更新，最终能达到数据一致就行

延时双删

~~~go
redis.del(key)
db.Update(data)
time.Sleep(1)  
redis.del(key)   
// 再删除一次的意思是防止B事务，在A事务还没有更新完数据库又去读取了一次，
// 造成缓存再次是旧的数据
~~~





#### 问题 7：Redis的缓存雪崩、穿透、击穿了解么？有什么异同点？分别怎么解决？

1.  缓存雪崩

    *   应用的缓存数据一般都是定时任务去刷新或者查不到再去更新

    *   假设某种情况下大面积【大量】Key同时失效，造成Redis无数据，此时大量的请求进来造成压力全部打到数据库
        *   要么造成业务延迟
        *   严重数据库直接宕机
    *   解决方案
        *   设置Key的时候随机给上他们的过期时间，保证不在同一时间大面积失效
        *   设置热点数据永不过期，需要更新的时候更新就好了

2.  缓存穿透

    *   不断请求数据缓存和数据库中都没有的数据，导致大量请求直接穿透到数据库，造成数据库压力过大
        *   比如请求id为负的记录或者id不存在于数据库的记录
        *   或者分页的参数不在数据库范围
    *   解决方案
        *   一定要在接口层做严格的参数校验、用户权限校验
        *   还可以做接口请求的频率限制【避免恶意请求】
        *   或者返回信息提示用户稍后重试，或者**设置Key的默认值Null**、位置错误、【友好的方案】
        *   高级方案【布隆过滤器】【快速判断出你这个Key是否在数据库中存在】

3.  缓存击穿

    *   指一个热点Key一直被大量请求，一旦Key失效，大量请求落到数据库上，造成数据库压力增大
    *   解决方案【设置热点数据不过期并且加上互斥锁】

4.  如何做避免以上的情况尽可能的不发生？

    *   做好Redis的高可用
    *   做好限流【牺牲部分用户】随机的返回一些请求
    *   服务降级【牺牲业务体验】停止某不重要的服务
    *   持久化重启恢复数据

    

#### 问题 8：MySQL里有2000w数据，Redis中只存20w的数据，如何保证Redis中的数据都是热点数据？

Redis 内存数据集大小上升到一定大小的时候，就会施行数据淘汰策略



#### 问题 9：常规的缓存+数据库读写模式？

1.  模式

    *   先读缓存，如果没有再去读数据库，然后写缓存，最后返回响应
    *   更新的时候先更新数据库，然后删除缓存

2.  为什么是删除缓存，而不是更新

    *   缓存的数据组成不一定就是更新的数据库的数据，可能是复杂的计算后的结果
    *   涉及更新数据的缓存不一定是请求量非常高的数据，删除后当有请求来再去更新，是一种懒加载的方式

    

#### 问题10：缓存与数据库双存储双写，如何解决数据不一致性问题？

只有在对一个数据在高并发的进行读写的时候，才可能会出现这种问题

1.  方案1【初级不一致解决】
    *   先修改数据库
    *   再去删除缓存——>如果删除失败——>造成数据库是新数据——>缓存是脏数据
2.  方案2【比较复杂的数据不一致解决】
    *   先删除缓存
    *   再去修改数据库——>如果此时有请求来查发现缓存没有数据——>去查数据库——>此时是脏数据
3.  高并发下终极解决办法【单个线程处理操作的队列】
    *   删除缓存
    *   然后去更新数据库【入队列】
    *   读操作来到【可以设置超时时间】
        *   发现缓存无数据——>数据库请求【入队列】——>更新缓存【入队列】
    *   结果就是所有的操作串型化执行，保证了数据一致性，但是降低了系统的吞吐量
    
    

#### 问题11：Redis事务？

1.  一次执行多个命令，EXEC执行前将命令**放入队列缓存**
2.  EXEC命令执行保证串行并且全部执行, 但是执行失败不会回滚, 而是继续执行
3.  事务执行过程对其他命令是隔离的
4.  事务是批量指令并非原子化操作，中间某条指令的失败不会导致前面已做指令的回滚，也不会造成后续的指令不做

Redis事务命令？MULTI 、EXEC、DISCARD、WATCH

5.  可以watch一个key，强制原子化命令队列，如果监听到的key发生改变，那么事务队列不会执行



#### 问题13：Redis一个value最大值？

512M



#### 问题14：Redis内存优化？

1.  手动或者自动清理内存碎片
2.  尽可能使用Hash，占用的空间少



#### 问题15：Redis集群Hash槽？数据库选择？

1.  16384个
2.  默认都是0号数据库



#### 问题16：zset如何依据两个字段排序？

1.  热度+时间作为排序字段， 这种特点的场景，解决方法是组装一个浮点数，整数部分 是热度的值，小数部分是时间
2.  redis 里面精度应该是小数 6 位，所以不 能把整个日期作为小数部分