[TOC]

### Redis高级部分

#### 主从架构原理是什么?

主从的架构目的是为了读写分离, 写master, 读slave, 减轻master压力, 提高可用性. 

1.  Redis可以进行主从同步以及从从同步, 缓解主库的压力, **一般master写, slave读**

2.  CAP理论一致性和可用性两难全, 但是从库会努力追赶主库达到最终一致性

3.  主从同步是异步进行的，所以不影响master的操作

4.  流程
    *   当从节点第一次加入时, 主节点做一次bgsave, 也就是快照, 同时将后续修改操作记录到内存buffer
    *   将快照的文件传送到从节点, 从节点清空内存数据, 立即执行全量加载, 然后通知主节点进行后续增量同步
    *   后续的增量数据通过AOF日志同步即可

5.  缺点
    *   环形buffer大小配置, 但是有限的, 可能会覆盖前面的指令, 所以需要配置大小合适的buffer
    *   所以主从的形式并不能保证数据不丢失


#### Redis主从模式 + 哨兵

主从模式提高了系统的能力，但是一旦master宕机，系统将不能对外服务，可以利用哨兵机制【特殊的Redis实例】

-   作用

    *   监控节点状态
    *   当Master节点故障时，自动提升Replication（Slave）为Master
    *   发送故障通知
    *   配置传播（就是把更新后的集群配置传播给其他哨兵进行更新，保持一致性）

-   方式

    -   采用3或者5个Redis实例作为哨兵，形成高可用的模式
    -   哨兵负责持续监控从节点的健康, 当主节点挂掉时【Raft选举算法】
        *   从哨兵中选取一个leader，然后该leader选择一个最优的slave切换为master
        *   修改其他slave的配置，指向新的master

-   使用哨兵模式

    *   客户端来连接系统,会首先连接 sentinel来查询主节点的地址

    然后再去连接主节点进行数据交互

-   缺点：无法保证数据不丢失, 因为主从数据同步采用的是异步的形式, 主库挂掉但是数据还没同步过去

#### Redis集群？

1.  Redis集群重在对Redis进行扩展，将Redis的数据按照一定规则分配到多台服务器【海量数据+高并发+高可用】
2.  节点连成去中心化方式集群, 采用特殊的二进制协议交换数据
3.  配置集群至少需要六个节点，三主三从
    *   不同的master不同数据
    *   master和slave数据一致
4.  集群情况下, Key如何寻址？

    *   采用Hash槽的形式用来定位Key所在的Redis实例
    *   默认16384个slots，分布在Redis实例【槽的数目可以更改】
    *   对Key做crc16的Hash算法得到一个整数值, 然后对16384取模得到key具体的槽位
    *   经过 **gossip 协议，周期性的和集群中的其他节点交换信息，最终 整个集群都会知道 key 在哪一个槽上**
5.  缺点
    *   集群下多key无法操作
    *   无法自动迁移

#### Redis集群如何高可用？

1.  主节点可以设置多个从节点, 单主节点故障可以进行选举主从切换
2.  如果某个主节点没有从节点, 如果故障会导致集群不可用, 但是可以设置配置, 允许部分节点故障
3.  **Gossip通信协议**
    *   数据分片【槽】和节点的对应关系
    *   集群中每个节点可用状态
    *   集群结构发生变更时，通过一定的协议对配置信息达成一致
4.  选举主从切换【Redis Cluster 重用了 Sentinel 的代码逻辑】
    *   集群中的每个节点都会定期地向集群中的其他节点发送 PING 消息，以此交换各个节点状态 信息，检测各个节点状态:在线状态、疑似下线状态 PFAIL、已下线状态 FAIL
5.  如果是主节点FAIL【Raft领头选举算法】

    *   首先：其他主节点对FAIL主节点的所有从节点的过滤, 依据是从节点与其主节点断开时间
    *   然后：再依据从节点对主节点的复制数据offset来排序【选出一个适合的从节点】
    *   最后：其他的有投票权的主节点来进行选举, 超过 n/2 + 1通过，该从节点切换为主节点
        *   撤销所有对已下线主节点的槽指派，并将这些槽全部指派给自己
        *   对集群进行广播 PONG 消息，告知其他节点已经成为新的主节点
        *   开始接收和处理槽相关的请求
6.  缺点
    *   不支持多数据库，默认0号库【0-16】
    *   key 批量操作支持有限
